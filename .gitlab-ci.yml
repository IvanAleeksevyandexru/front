image: node:latest

cache: &global_cache
  key: cache-${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - dist/

stages:
  - install
  - lint
  - test
  - library-build
  - publish
  - build

Install:
  stage: install
  before_script:
    - rm -rf dist
  script:
    - yarn install
  only:
    - merge_requests
    - master

Lint:
  stage: lint
  cache:
    <<: *global_cache
    policy: pull  
  script:
    - yarn lint
  only:
    - merge_requests
    - master

Test:
  stage: test
  cache:
    <<: *global_cache
    policy: pull  
  script:
    - yarn test:coverage
  only:
    - merge_requests
    - master

Library-build:
  stage: library-build
  script:
    - yarn library:build
  only:
    - merge_requests
    - master

Library-publish:
  stage: publish
  cache:
    <<: *global_cache
    policy: pull  
  before_script:
    - echo "registry=http://npm.gosuslugi.local/" > ~/.npmrc
    - echo "//npm.gosuslugi.local/:_authToken=\"${NPM_TOKEN}\"" >> ~/.npmrc
  script:
    - cd dist/epgu-constructor
    - CURRENT_VERSION=$(npm view epgu-constructor version)
    - npm version $CURRENT_VERSION
    - npm version patch
    - npm publish
  only:
    - master    
    
Build:
  stage: build
  cache:
    <<: *global_cache
    policy: pull
  script:
    - yarn build
    - /devops/notify/notify.sh fronted_new_master_available
  only:
    - merge_requests
    - master
