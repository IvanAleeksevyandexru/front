image: node:latest

cache: &global_cache
  key: cache-${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - dist/

stages:
  - install
  - code-quality
  - library-build
  - publish
  - build
  - image
  - deploy
  
Install:
  stage: install
  before_script:
    - rm -rf dist
  script:
    - yarn install
  only:
    - merge_requests
    - master

Lint:
  stage: code-quality
  cache:
    <<: *global_cache
    policy: pull
  script:
    - yarn lint
  only:
    - merge_requests
    - master

Test:
  stage: code-quality
  cache:
    <<: *global_cache
    policy: pull
  script:
    - yarn test:coverage
  only:
    - merge_requests
    - master

Library-build:
  stage: library-build
  script:
    - yarn lib:build
  only:
    - merge_requests
    - master

Library-publish:
  stage: publish
  cache:
    <<: *global_cache
    policy: pull
  before_script:
    - echo "registry=http://npm.gosuslugi.local/" > ~/.npmrc
    - echo "//npm.gosuslugi.local/:_authToken=\"${NPM_TOKEN}\"" >> ~/.npmrc
  script:
    - cd dist/epgu-constructor
    - CURRENT_VERSION=$(npm view epgu-constructor version)
    - npm version $CURRENT_VERSION
    - npm version patch
    - npm publish
  only:
    - master

Build:
  stage: build
  script:
    - yarn build --prod
    - /devops/notify/notify.sh fronted_new_master_available
  only:
    - merge_requests
    - master

Build-image:
  stage: image
  cache:
    <<: *global_cache
    policy: pull
  services:
    - name: docker:dind
      command: ['--insecure-registry', 'registry.gosuslugi.local']
  image: docker:latest
  variables:
    GIT_STRATEGY: none
  before_script:
    - docker login -u $REGISTRY_USER -p $REGISTRY_PASSWORD $REGISTRY
  script:
    - docker build --tag $REGISTRY/$IMAGE:$CI_COMMIT_SHA --tag $REGISTRY/$IMAGE:$CI_COMMIT_REF_SLUG .
    - docker push $REGISTRY/$IMAGE:$CI_COMMIT_SHA
    - docker push $REGISTRY/$IMAGE:$CI_COMMIT_REF_SLUG
  only:
    - merge_requests
    - master

Deploy to review env:
  stage: deploy
  cache: {}
  variables:
    GIT_STRATEGY: none
  before_script:
    - export PATH=$PATH:/devops/k8s/bin
  script:
    - echo http://review-$CI_COMMIT_REF_SLUG.pgu2-dev.test.gosuslugi.ru
    - deploy
  environment:
    name: review/$CI_COMMIT_REF_NAME
    url: http://review-$CI_COMMIT_REF_SLUG.pgu2-dev.test.gosuslugi.ru
    on_stop: "Drop review env"
  only:
    - merge_requests
    - master

Drop review env:
  stage: deploy
  cache: {}
  variables:
    GIT_STRATEGY: none
  before_script:
    - export PATH=$PATH:/devops/k8s/bin    
  script:
    - echo "Delete environment $CI_COMMIT_REF_SLUG"
    - stop
  when: manual
  environment:
    name: review/$CI_COMMIT_REF_NAME
    action: stop
  only:
    - merge_requests
    - master
