include:
  - project: appsec/cicd
    file: /luxsoft/epgu2-form-frontend.yml

image: node:14

cache:
  key:
    files:
      - yarn.lock
  paths:
    - .yarn
    - .yarn-cache/
    - node_modules
    - 'projects/*/node_modules'
  policy: pull
  untracked: true

stages:
  - install
  - types-build
  - code-quality
  - ui-kit-build
  - children-clubs-build
  - form-player-build
  - emulator-build
  - portal-build
  - image
  - deploy
  - code_check

Install:
  stage: install
  except:
    variables:
      - $GITLAB_USER_LOGIN == $CI_USER
  script:
    - echo 'Warming the cache'
    - test -d node_modules || yarn install --frozen-lockfile --no-progress
  cache:
    key:
      files:
        - yarn.lock
    policy: pull-push
    paths:
      - .yarn
      - .yarn-cache/
      - node_modules
      - 'projects/*/node_modules'
  interruptible: true
  only:
    - merge_requests
    - master
    - stage

Types-build:
  stage: types-build
  except:
    variables:
      - $GITLAB_USER_LOGIN == $CI_USER
  cache:
    - key:
        files:
          - yarn.lock
      policy: pull
      paths:
        - .yarn
        - .yarn-cache/
        - node_modules
        - 'projects/*/node_modules'
    - key: cache-${CI_COMMIT_REF_SLUG}
      policy: push
      paths:
        - dist
        - projects/epgu-constructor-types/dist
  script:
    - yarn build:types
  interruptible: true
  needs: ["Install"]
  only:
    - merge_requests
    - master
    - stage

Lint:
  stage: code-quality
  except:
    variables:
      - $GITLAB_USER_LOGIN == $CI_USER
  script:
    - echo -e "##########\nlint\n##########"
    - yarn lint
    - yarn stylelint
    - echo -e "##########\ndone\n##########"
  interruptible: true
  needs: ["Install"]
  only:
    - merge_requests
    - master
    - stage

Test:
  stage: code-quality
  except:
    variables:
      - $GITLAB_USER_LOGIN == $CI_USER
  script:
    - echo -e "##########\ntest\n##########"
    - yarn test:ci
    - echo -e "##########\ndone\n##########"
  interruptible: true
  needs: ["Install"]
  only:
    - merge_requests
    - master
    - stage

Ui-kit-build:
  stage: ui-kit-build
  except:
    variables:
      - $GITLAB_USER_LOGIN == $CI_USER
  cache:
    - key:
        files:
          - yarn.lock
      policy: pull
      paths:
        - .yarn
        - .yarn-cache/
        - node_modules
        - 'projects/*/node_modules'
    - key: cache-${CI_COMMIT_REF_SLUG}
      policy: pull-push
      paths:
        - dist
        - projects/epgu-constructor-types/dist
  script:
    - yarn build:ui-kit
  interruptible: true
  needs: ["Install", "Types-build"]
  only:
    - merge_requests
    - master
    - stage

Children-clubs-build:
  stage: children-clubs-build
  except:
    variables:
      - $GITLAB_USER_LOGIN == $CI_USER
  cache:
    - key:
        files:
          - yarn.lock
      policy: pull
      paths:
        - .yarn
        - .yarn-cache/
        - node_modules
        - 'projects/*/node_modules'
    - key: cache-${CI_COMMIT_REF_SLUG}
      policy: pull-push
      paths:
        - dist
        - projects/epgu-constructor-types/dist
  script:
    - yarn build:children-clubs
  interruptible: true
  needs: ["Ui-kit-build"]
  only:
    - merge_requests
    - master
    - stage

Form-player-build:
  stage: form-player-build
  except:
    variables:
      - $GITLAB_USER_LOGIN == $CI_USER
  cache:
    - key:
        files:
          - yarn.lock
      policy: pull
      paths:
        - .yarn
        - .yarn-cache/
        - node_modules
        - 'projects/*/node_modules'
    - key: cache-${CI_COMMIT_REF_SLUG}
      policy: pull-push
      paths:
        - dist
        - projects/epgu-constructor-types/dist
  script:
    - yarn build:cf
  interruptible: true
  needs: ["Ui-kit-build"]
  only:
    - merge_requests
    - master
    - stage

Emulator-build:
  stage: emulator-build
  except:
    variables:
      - $GITLAB_USER_LOGIN == $CI_USER
  cache:
    - key:
        files:
          - yarn.lock
      policy: pull
      paths:
        - .yarn
        - .yarn-cache/
        - node_modules
        - 'projects/*/node_modules'
    - key: cache-${CI_COMMIT_REF_SLUG}
      policy: pull-push
      paths:
        - dist
        - projects/epgu-constructor-types/dist
  script:
    - yarn build:emulator
  interruptible: true
  needs: ["Children-clubs-build", "Form-player-build"]
  only:
    - merge_requests

Portal-build:
  stage: portal-build
  except:
    variables:
      - $GITLAB_USER_LOGIN == $CI_USER
  cache:
    - key:
        files:
          - yarn.lock
      policy: pull
      paths:
        - .yarn
        - .yarn-cache/
        - node_modules
        - 'projects/*/node_modules'
  script:
    - test -d node_modules || yarn install --frozen-lockfile --no-progress
    - yarn build:portal
  interruptible: true
  needs: ["Install"]
  only:
    - merge_requests
    - master
    - stage
