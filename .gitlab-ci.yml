include:
  - project: appsec/cicd
    file: /luxsoft/epgu2-form-frontend.yml

image: node:14

cache: &global_cache
  key: cache-${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - dist/
    - projects/epgu-constructor/node_modules
    - projects/epgu-constructor-types/node_modules
    - projects/epgu-constructor-types/dist

stages:
  - install
  - postinstall
  - code-quality
  - ui-kit-build
  - children-clubs-build
  - library-build
  - library-publish
  - build
  - portal-build
  - image
  - deploy
  - code_check
Install:
  stage: install
  except:
    variables:
      - $GITLAB_USER_LOGIN == $CI_USER
  before_script:
    - rm -rf dist
  script:
    - yarn install
  only:
    - merge_requests
    - master
    - stage

Pre-build:
  stage: postinstall
  except:
    variables:
      - $GITLAB_USER_LOGIN == $CI_USER
  cache:
    <<: *global_cache
  script:
    - yarn build:types
  only:
    - merge_requests
    - master
    - stage

Lint:
  stage: code-quality
  except:
    variables:
      - $GITLAB_USER_LOGIN == $CI_USER
  cache:
    <<: *global_cache
    policy: pull
  script:
    - echo -e "##########\nlint\n##########"
    - yarn lint
    - yarn stylelint
    - echo -e "##########\ndone\n##########"
  only:
    - merge_requests
    - master
    - stage

Test:
  stage: code-quality
  except:
    variables:
      - $GITLAB_USER_LOGIN == $CI_USER
  cache:
    <<: *global_cache
    policy: pull
  script:
    - echo -e "##########\ntest\n##########"
    - yarn test:coverage
    - echo -e "##########\ndone\n##########"
  artifacts:
    reports:
      cobertura: coverage/jest/cobertura-coverage.xml
      junit: coverage/junit/test-results.xml
  only:
    - merge_requests
    - master
    - stage

Children-clubs-build:
  stage: children-clubs-build
  except:
    variables:
      - $GITLAB_USER_LOGIN == $CI_USER
  script:
    - yarn build:children-clubs
  only:
    - merge_requests
    - master
    - stage

Ui-kit-build:
  stage: ui-kit-build
  except:
    variables:
      - $GITLAB_USER_LOGIN == $CI_USER
  script:
    - yarn build:ui-kit
  only:
    - merge_requests
    - master
    - stage

Library-build:
  stage: library-build
  except:
    variables:
      - $GITLAB_USER_LOGIN == $CI_USER
  script:
    - yarn build:cf
  only:
    - merge_requests
    - master
    - stage

Build:
  stage: build
  except:
    variables:
      - $GITLAB_USER_LOGIN == $CI_USER
  script:
    - yarn build:emulator
  #    - /devops/notify/notify.sh fronted_new_master_available
  only:
    - merge_requests

Portal-build:
  stage: portal-build
  except:
    variables:
      - $GITLAB_USER_LOGIN == $CI_USER
  script:
    - yarn install
    - yarn build:portal
  only:
    - merge_requests
    - master
    - stage

